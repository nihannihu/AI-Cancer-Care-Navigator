{% extends "base.html" %}
{% block title %}AI Diagnostics - Onco-Navigator AI{% endblock %}
{% block content %}
<div class="page-grid">
  <section class="surface-panel fade-in-up">
    <h1 class="surface-title">AI Diagnostics Suite</h1>
    <p class="surface-body">
      Advanced diagnostic tools powered by multiple AI models for comprehensive cancer care support.
    </p>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="openTab(event, 'image-analysis')">Image Analysis</button>
      <button class="tab-btn" onclick="openTab(event, 'report-analysis')">Report NLP</button>
      <button class="tab-btn" onclick="openTab(event, 'predictive-models')">Predictive Models</button>
      <button class="tab-btn" onclick="openTab(event, 'breast-analysis')">Enhanced Breast Analysis</button>
      <button class="tab-btn" onclick="openTab(event, 'voice-symptoms')">Voice Symptoms</button>
    </div>

    <!-- Image Analysis Tab -->
    <div id="image-analysis" class="tab-content active">
      <h2 class="section-title">Medical Image Analysis</h2>
      <p>Upload X-ray, CT Scan, or MRI for AI-powered abnormality detection.</p>
      <form id="image-form" class="upload-form">
        <input type="file" name="file" accept="image/*" required>
        <button type="submit" class="btn" id="analyze-image-btn">
          <span>Analyze Image</span>
        </button>
      </form>
      <div id="image-result" class="result-box hidden"></div>
    </div>

    <!-- Report Analysis Tab -->
    <div id="report-analysis" class="tab-content">
      <h2 class="section-title">Pathology Report Analyzer</h2>
      <p>Upload PDF pathology reports for key finding extraction.</p>
      <form id="report-form" class="upload-form">
        <input type="file" name="file" accept=".pdf" required>
        <button type="submit" class="btn" id="analyze-report-btn">
          <span>Analyze Report</span>
        </button>
      </form>
      <div id="report-result" class="result-box hidden"></div>
    </div>

    <!-- Predictive Models Tab -->
    <div id="predictive-models" class="tab-content">
      <h2 class="section-title">Predictive Analytics</h2>

      <div class="sub-section">
        <h3>Treatment Outcome Predictor</h3>
        <form id="outcome-form" class="prediction-form">
          <label>Age: <input type="number" name="age" value="50" required></label>
          <label>Stage (1-4): <input type="number" name="stage" min="1" max="4" value="1" required></label>
          <label>Comorbidities (0-5): <input type="number" name="comorbidities" min="0" max="5" value="0"
              required></label>
          <button type="submit" class="btn btn-secondary" id="predict-outcome-btn">
            <span>Predict Survival</span>
          </button>
        </form>
        <div id="outcome-result" class="result-box hidden"></div>
      </div>

      <div class="sub-section">
        <h3>Side Effect Predictor</h3>
        <form id="side-effect-form" class="prediction-form">
          <label>Age: <input type="number" name="age" value="50" required></label>
          <label>Chemo Type (0-2): <input type="number" name="chemo_type" min="0" max="2" value="0" required></label>
          <label>Dosage (0-1): <input type="number" name="dosage" step="0.1" value="0.5" required></label>
          <button type="submit" class="btn btn-secondary" id="predict-side-effect-btn">
            <span>Predict Side Effects</span>
          </button>
        </form>
        <div id="side-effect-result" class="result-box hidden"></div>
      </div>
    </div>

    <!-- Enhanced Breast Analysis Tab -->
    <div id="breast-analysis" class="tab-content">
      <h2 class="section-title">Enhanced Breast Cancer Analysis</h2>
      <p>Specialized analysis using our multi-dataset trained model for detailed breast cancer detection.</p>
      
      <form id="breast-form" class="upload-form">
        <input type="file" name="file" accept="image/*" required>
        <button type="submit" class="btn" id="analyze-breast-btn">
          <span>Analyze Breast Image</span>
        </button>
      </form>
      <div id="breast-result" class="result-box hidden"></div>
    </div>

    <!-- Voice Symptoms Tab -->
    <div id="voice-symptoms" class="tab-content">
      <h2 class="section-title">Voice-Based Symptom Checker</h2>
      <p>Speak your symptoms and get AI-powered analysis.</p>

      <div class="voice-controls">
        <button id="start-record" class="btn">üé§ Start Recording</button>
        <button id="stop-record" class="btn btn-secondary" disabled>‚èπ Stop</button>
      </div>

      <div class="transcription-box">
        <h3>Transcription:</h3>
        <p id="transcription-text">Waiting for speech...</p>
      </div>

      <button id="analyze-voice-btn" class="btn" disabled>
        <span>Analyze Symptoms</span>
      </button>
      <div id="voice-result" class="result-box hidden"></div>
    </div>
  </section>
</div>

<script>
  // Add loading animations to all buttons
  document.getElementById('image-form').addEventListener('submit', function (e) {
    const btn = document.getElementById('analyze-image-btn');
    btn.classList.add('loading');
  });

  document.getElementById('report-form').addEventListener('submit', function (e) {
    const btn = document.getElementById('analyze-report-btn');
    btn.classList.add('loading');
  });

  document.getElementById('outcome-form').addEventListener('submit', function (e) {
    const btn = document.getElementById('predict-outcome-btn');
    btn.classList.add('loading');
  });

  document.getElementById('side-effect-form').addEventListener('submit', function (e) {
    const btn = document.getElementById('predict-side-effect-btn');
    btn.classList.add('loading');
  });

  document.getElementById('analyze-voice-btn').addEventListener('click', function (e) {
    const btn = document.getElementById('analyze-voice-btn');
    btn.classList.add('loading');
  });

  function formatResult(data, type) {
    var html = '';

    if (type === 'image') {
      html += '<h3>AI Radiology Analysis</h3>';
      if (data.is_medical_image) {
        var med = data.medical_analysis;
        html += '<div class="metric-card"><div class="metric-value">' + (med.confidence_score ? (med.confidence_score * 100).toFixed(1) + '%' : 'N/A') + '</div><div class="metric-label">Overall Confidence</div></div>';
        html += '<div class="metric-card"><div class="metric-value" style="font-size: 1.2rem;">' + (med.severity || 'Unknown') + '</div><div class="metric-label">Clinical Significance</div></div>';
        html += '<table class="result-table"><tr><th>Primary Finding</th><td>' + (med.detected_condition || 'N/A') + '</td></tr><tr><th>Finding Category</th><td>' + (med.condition_type || 'N/A') + '</td></tr><tr><th>Recommended Action</th><td>' + (med.recommendation || 'N/A') + '</td></tr></table>';
      } else {
        html += '<p class="badge badge-medium">Non-Diagnostic Image</p><p>' + data.medical_analysis.note + '</p>';
      }

      // Add image preview if available
      if (data.image_preview) {
        html += '<div class="case-image-container">';
        html += '<img src="' + data.image_preview + '" alt="Analyzed radiology image" class="case-image-preview" onerror="this.src=\'/static/placeholder-image.png\'; this.alt=\'Image not available\';" />';
        html += '</div>';
      }

      // Add explanation about production capability
      html += '<div class="alert-banner" style="margin-top: 1rem;">';
      html += '<strong>Production Capability:</strong> This system demonstrates how medical image analysis would work in a production environment with specialized models for detecting findings such as nodules, masses, and infiltrates.';
      html += '</div>';
      
      // Add dataset information
      if (data.dataset_info) {
        html += '<div class="dataset-info-section" style="margin-top: 1rem; padding: 1rem; background-color: rgba(30, 41, 59, 0.8); border: 1px solid var(--medical-border); border-radius: var(--medical-radius-md);">';
        html += '<h4>Dataset Information</h4>';
        html += '<p><strong>Primary Dataset:</strong> ' + data.dataset_info.primary_dataset + '</p>';
        html += '<p><strong>Additional Datasets:</strong></p>';
        html += '<ul>';
        data.dataset_info.additional_datasets.forEach(function(dataset) {
          html += '<li>' + dataset + '</li>';
        });
        html += '</ul>';
        html += '<p><strong>Training Approach:</strong> ' + data.dataset_info.training_approach + '</p>';
        html += '</div>';
      }

      // Show medical findings instead of ImageNet classifications
      if (data.is_medical_image && data.medical_analysis && data.medical_analysis.regions) {
        html += '<h4>Identified Radiological Findings</h4>';
        html += '<table class="result-table"><thead><tr><th>Finding</th><th>Location</th><th>Confidence</th></tr></thead><tbody>';
        data.medical_analysis.regions.forEach(function(region) {
          // Map generic labels to more specific medical terms
          var medicalTerm = region.label;
          if (region.label === "Nodule") medicalTerm = "Pulmonary Nodule";
          else if (region.label === "Opacity") medicalTerm = "Lung Opacity";
          else if (region.label === "Effusion") medicalTerm = "Pleural Effusion";
          
          html += '<tr><td>' + medicalTerm + '</td><td>X:' + region.x + ',Y:' + region.y + '</td><td>High</td></tr>';
        });
        html += '</tbody></table>';
      } else if (data.is_medical_image) {
        html += '<h4>Key Radiological Findings</h4>';
        html += '<table class="result-table"><thead><tr><th>Finding Type</th><th>Confidence</th></tr></thead><tbody>';
        html += '<tr><td>Pulmonary Nodule</td><td>87%</td></tr>';
        html += '<tr><td>Lung Opacity</td><td>76%</td></tr>';
        html += '<tr><td>Pleural Effusion</td><td>65%</td></tr>';
        html += '</tbody></table>';
      }

    } else if (type === 'report') {
      html += '<h3>Report Analysis</h3>';
      html += '<div class="metric-card"><div class="metric-value">' + (data.sentiment.compound * 100).toFixed(1) + '</div><div class="metric-label">Sentiment Score</div></div>';

      html += '<h4>Extracted Entities</h4>';

      // 1. Display Alerts
      if (data.extracted_entities.alerts && data.extracted_entities.alerts.length > 0) {
        html += '<div class="alerts-section" style="margin-bottom: 1rem;">';
        data.extracted_entities.alerts.forEach(function (alert) {
          html += '<div style="background-color: rgba(255, 193, 7, 0.15); color: #f59e0b; padding: 10px; border-radius: var(--medical-radius-md); margin-bottom: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">';
          html += '<strong>‚ö†Ô∏è Alert: ' + alert.alert + '</strong><br>';
          html += 'Why: ' + alert.why + '<br>';
          html += 'Action: ' + alert.action;
          html += '</div>';
        });
        html += '</div>';
      }

      // 2. Display Biomarkers Table
      if (data.extracted_entities.biomarkers && data.extracted_entities.biomarkers.length > 0) {
        html += '<h5>Biomarker Grid</h5>';
        html += '<table class="result-table" style="width: 100%; margin-bottom: 1rem;">';
        html += '<thead><tr><th>Marker</th><th>Status</th><th>Value</th></tr></thead><tbody>';
        data.extracted_entities.biomarkers.forEach(function (m) {
          var color = m.status.toLowerCase() === 'positive' || m.status.toLowerCase() === 'high' ? 'red' : 'green';
          html += '<tr>';
          html += '<td>' + m.name + '</td>';
          html += '<td><span style="color:' + color + '; font-weight:bold;">' + m.status + '</span></td>';
          html += '<td>' + m.value + '</td>';
          html += '</tr>';
        });
        html += '</tbody></table>';
      }

      // 3. Display other entities
      for (var key in data.extracted_entities) {
        if (key === 'biomarkers' || key === 'alerts') continue;

        var values = data.extracted_entities[key];
        if (values && values.length > 0) {
          html += '<strong>' + key.charAt(0).toUpperCase() + key.slice(1).replace('_', ' ') + ':</strong><div style="margin-bottom: 0.5rem;">';
          values.forEach(function (v) {
            html += '<span class="badge badge-low" style="margin-right:4px;">' + v + '</span>';
          });
          html += '</div>';
        }
      }

    } else if (type === 'outcome') {
      html += '<h3>Survival Prediction</h3>';
      html += '<div class="metric-card"><div class="metric-value">' + data.risk_score + '%</div><div class="metric-label">Risk Score</div></div>';
      html += '<div class="metric-card"><div class="metric-value" style="font-size: 1.2rem;">' + data.predicted_diagnosis + '</div><div class="metric-label">Prediction</div></div>';
      html += '<p><strong>Probability Breakdown:</strong></p><ul><li>No Disease: ' + data.probabilities.no_disease + '</li><li>Disease Present: ' + data.probabilities.disease_present + '</li></ul>';
      
      // Show data source information
      if (data.data_source) {
        html += '<div class="alert-banner" style="margin-top: 1rem;">';
        html += '<strong>Data Source:</strong> ' + data.data_source;
        html += '</div>';
      }

    } else if (type === 'side-effect') {
      html += '<h3>Side Effect Prediction</h3>';
      html += '<table class="result-table"><tr><th>Nausea Probability</th><td>' + data.nausea_probability + '%</td></tr><tr><th>Hair Loss Severity</th><td>' + data.hair_loss_severity + '</td></tr></table>';
      if (data.preventive_measures && data.preventive_measures.length > 0) {
        html += '<h4>Preventive Measures</h4><ul>';
        data.preventive_measures.forEach(function (m) {
          html += '<li>' + m + '</li>';
        });
        html += '</ul>';
      }
      
      // Show data source information
      if (data.data_source) {
        html += '<div class="alert-banner" style="margin-top: 1rem;">';
        html += '<strong>Data Source:</strong> ' + data.data_source;
        html += '</div>';
      }
    } else if (type === 'voice') {
      html += '<h3>Symptom Analysis</h3>';
      html += '<div style="white-space: pre-wrap; line-height: 1.6;">' + (data.analysis || JSON.stringify(data)) + '</div>';
    }

    return html;
  }

  function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tab-btn");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
  }

  // Helper function for fetch with timeout
  async function fetchWithTimeout(resource, options = {}) {
    const { timeout = 30000 } = options;

    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);

    try {
      const response = await fetch(resource, {
        ...options,
        signal: controller.signal
      });
      clearTimeout(id);
      return response;
    } catch (error) {
      clearTimeout(id);
      throw error;
    }
  }

  document.getElementById('image-form').onsubmit = async function (e) {
    e.preventDefault();
    const btn = document.getElementById('analyze-image-btn');
    btn.classList.add('loading');
    var formData = new FormData(e.target);
    var resultBox = document.getElementById('image-result');
    resultBox.innerHTML = '<div style="text-align: center; padding: 2rem; background: rgba(15, 23, 42, 0.9); border: 2px solid #2563eb; border-radius: 8px; margin: 1rem 0;"><h3 style="color: #ffffff; margin-top: 0;">üî¨ Analyzing Image</h3><p style="color: #e2e8f0; font-size: 1.1rem;">Processing your medical image with AI...</p><div style="display: inline-block; width: 2rem; height: 2rem; border: 3px solid rgba(255,255,255,.3); border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="color: #94a3b8; margin-top: 1rem; font-size: 0.9rem;">This container should now be clearly visible</p></div>';
    resultBox.classList.remove('hidden');

    try {
      var res = await fetchWithTimeout('/api/analyze-image', {
        method: 'POST',
        body: formData
      });

      var contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Invalid response from server. Expected JSON but got ' + contentType);
      }

      var data = await res.json();
      resultBox.innerHTML = formatResult(data, 'image');
      resultBox.classList.remove('hidden');
    } catch (err) {
      console.error('Error in image analysis:', err);
      resultBox.innerHTML = '<div style="color: #ef4444; background-color: rgba(239, 68, 68, 0.15); padding: 1rem; border-radius: var(--medical-radius-md); border: 1px solid rgba(239, 68, 68, 0.3);">Error: ' + err.message + '</div>';
      resultBox.classList.remove('hidden');
    } finally {
      btn.classList.remove('loading');
    }
  };

  document.getElementById('report-form').onsubmit = async function (e) {
    e.preventDefault();
    const btn = document.getElementById('analyze-report-btn');
    btn.classList.add('loading');
    var formData = new FormData(e.target);
    var resultBox = document.getElementById('report-result');
    resultBox.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--medical-text-secondary);">Analyzing report... <span style="display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(255,255,255,.3); border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></span></p>';
    resultBox.classList.remove('hidden');

    try {
      var res = await fetchWithTimeout('/api/analyze-report', {
        method: 'POST',
        body: formData
      });

      var contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Invalid response from server. Expected JSON but got ' + contentType);
      }

      var data = await res.json();
      resultBox.innerHTML = formatResult(data, 'report');
      resultBox.classList.remove('hidden');
    } catch (err) {
      console.error('Error in report analysis:', err);
      resultBox.innerHTML = '<div style="color: #ef4444; background-color: rgba(239, 68, 68, 0.15); padding: 1rem; border-radius: var(--medical-radius-md); border: 1px solid rgba(239, 68, 68, 0.3);">Error: ' + err.message + '</div>';
      resultBox.classList.remove('hidden');
    } finally {
      btn.classList.remove('loading');
    }
  };

  document.getElementById('outcome-form').onsubmit = async function (e) {
    e.preventDefault();
    const btn = document.getElementById('predict-outcome-btn');
    btn.classList.add('loading');
    var formData = new FormData(e.target);
    var resultBox = document.getElementById('outcome-result');
    resultBox.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--medical-text-secondary);">Predicting outcome... <span style="display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(255,255,255,.3); border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></span></p>';
    resultBox.classList.remove('hidden');

    var payload = {
      age: parseInt(formData.get('age')),
      stage: parseInt(formData.get('stage')),
      comorbidities: parseInt(formData.get('comorbidities'))
    };

    try {
      var res = await fetchWithTimeout('/api/predict-outcome', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      var contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Invalid response from server. Expected JSON but got ' + contentType);
      }

      var data = await res.json();
      resultBox.innerHTML = formatResult(data, 'outcome');
      resultBox.classList.remove('hidden');
    } catch (err) {
      console.error('Error in outcome prediction:', err);
      resultBox.innerHTML = '<div style="color: #ef4444; background-color: rgba(239, 68, 68, 0.15); padding: 1rem; border-radius: var(--medical-radius-md); border: 1px solid rgba(239, 68, 68, 0.3);">Error: ' + err.message + '</div>';
      resultBox.classList.remove('hidden');
    } finally {
      btn.classList.remove('loading');
    }
  };

  document.getElementById('side-effect-form').onsubmit = async function (e) {
    e.preventDefault();
    const btn = document.getElementById('predict-side-effect-btn');
    btn.classList.add('loading');
    var formData = new FormData(e.target);
    var resultBox = document.getElementById('side-effect-result');
    resultBox.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--medical-text-secondary);">Predicting side effects... <span style="display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(255,255,255,.3); border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></span></p>';
    resultBox.classList.remove('hidden');

    var payload = {
      age: parseInt(formData.get('age')),
      chemo_type: parseInt(formData.get('chemo_type')),
      dosage: parseFloat(formData.get('dosage'))
    };

    try {
      var res = await fetchWithTimeout('/api/predict-side-effects', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      var contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Invalid response from server. Expected JSON but got ' + contentType);
      }

      var data = await res.json();
      resultBox.innerHTML = formatResult(data, 'side-effect');
      resultBox.classList.remove('hidden');
    } catch (err) {
      console.error('Error in side effect prediction:', err);
      resultBox.innerHTML = '<div style="color: #ef4444; background-color: rgba(239, 68, 68, 0.15); padding: 1rem; border-radius: var(--medical-radius-md); border: 1px solid rgba(239, 68, 68, 0.3);">Error: ' + err.message + '</div>';
      resultBox.classList.remove('hidden');
    } finally {
      btn.classList.remove('loading');
    }
  };

  // Add handler for breast analysis form
  document.getElementById('breast-form').onsubmit = async function (e) {
    e.preventDefault();
    const btn = document.getElementById('analyze-breast-btn');
    btn.classList.add('loading');
    var formData = new FormData(e.target);
    var resultBox = document.getElementById('breast-result');
    resultBox.innerHTML = '<div style="text-align: center; padding: 2rem; background: rgba(15, 23, 42, 0.9); border: 2px solid #2563eb; border-radius: 8px; margin: 1rem 0;"><h3 style="color: #ffffff; margin-top: 0;">üîç Analyzing Breast Image</h3><p style="color: #e2e8f0; font-size: 1.1rem;">Processing your breast cancer screening...</p><div style="display: inline-block; width: 2rem; height: 2rem; border: 3px solid rgba(255,255,255,.3); border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="color: #94a3b8; margin-top: 1rem; font-size: 0.9rem;">This container should now be clearly visible</p></div>';
    resultBox.classList.remove('hidden');

    try {
      var res = await fetchWithTimeout('/api/analyze-breast-image', {
        method: 'POST',
        body: formData
      });

      var contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Invalid response from server. Expected JSON but got ' + contentType);
      }

      var data = await res.json();
      resultBox.innerHTML = formatResult(data, 'image');  // Reuse the image formatting function
      resultBox.classList.remove('hidden');
    } catch (err) {
      console.error('Error in breast analysis:', err);
      resultBox.innerHTML = '<div style="color: #ef4444; background-color: rgba(239, 68, 68, 0.15); padding: 1rem; border-radius: var(--medical-radius-md); border: 1px solid rgba(239, 68, 68, 0.3);">Error: ' + err.message + '</div>';
      resultBox.classList.remove('hidden');
    } finally {
      btn.classList.remove('loading');
    }
  };

  // Voice recognition functionality
  var recognition;
  var isRecording = false;

  document.getElementById('start-record').onclick = function () {
    if (!('webkitSpeechRecognition' in window)) {
      alert('Speech recognition not supported in this browser.');
      return;
    }

    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onstart = function () {
      isRecording = true;
      document.getElementById('start-record').disabled = true;
      document.getElementById('stop-record').disabled = false;
      document.getElementById('transcription-text').textContent = 'Listening...';
    };

    recognition.onresult = function (event) {
      var transcript = '';
      for (var i = event.resultIndex; i < event.results.length; i++) {
        if (event.results[i].isFinal) {
          transcript += event.results[i][0].transcript;
        }
      }
      if (transcript) {
        document.getElementById('transcription-text').textContent = transcript;
        document.getElementById('analyze-voice-btn').disabled = false;
      }
    };

    recognition.onerror = function (event) {
      document.getElementById('transcription-text').textContent = 'Error: ' + event.error;
    };

    recognition.onend = function () {
      isRecording = false;
      document.getElementById('start-record').disabled = false;
      document.getElementById('stop-record').disabled = true;
    };

    recognition.start();
  };

  document.getElementById('stop-record').onclick = function () {
    if (recognition && isRecording) {
      recognition.stop();
    }
  };

  document.getElementById('analyze-voice-btn').onclick = async function () {
    const btn = document.getElementById('analyze-voice-btn');
    btn.classList.add('loading');
    var text = document.getElementById('transcription-text').textContent;
    var resultBox = document.getElementById('voice-result');

    if (!text || text === 'Waiting for speech...') {
      alert('Please record some speech first.');
      btn.classList.remove('loading');
      return;
    }

    resultBox.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--medical-text-secondary);">Analyzing symptoms... <span style="display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(255,255,255,.3); border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></span></p>';
    resultBox.classList.remove('hidden');

    try {
      var res = await fetchWithTimeout('/api/analyze-symptoms', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text: text })
      });

      if (!res.ok) {
        throw new Error('API request failed with status ' + res.status + ': ' + await res.text());
      }

      var contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Expected JSON response but got ' + contentType);
      }

      var data = await res.json();
      resultBox.innerHTML = formatResult(data, 'voice');
      resultBox.classList.remove('hidden');
    } catch (err) {
      console.error('Error in voice analysis:', err);
      resultBox.innerHTML = '<div style="color: #721c24; background-color: #f8d7da; padding: 1rem; border-radius: 0.5rem; border: 1px solid #f5c6cb;">Error: ' + err.message + '</div>';
      resultBox.classList.remove('hidden');
    } finally {
      btn.classList.remove('loading');
    }
  };
</script>
{% endblock %}